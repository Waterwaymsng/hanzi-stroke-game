<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ±‰å­—ç¬”é¡ºç»ƒä¹ </title>

<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5.0/dist/hanzi-writer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
  :root{
    --bg:#f5f7fa;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --accent:#2563eb;
    --danger:#d9534f;
    --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Microsoft YaHei", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:24px;
    text-align:center;
  }
  .wrap{ max-width:900px; margin:0 auto; }
  .title{ font-size:24px; margin:6px 0 18px; font-weight:700; }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    box-shadow:0 6px 20px rgba(17,24,39,0.06);
    text-align:left;
    margin:14px 0;
  }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .row.left{ justify-content:flex-start; }
  .row.center{ justify-content:center; }
  .label{ font-size:14px; color:var(--muted); margin:0 0 10px; }
  textarea{
    width:100%;
    height:72px;
    font-size:18px;
    padding:12px;
    border:1px solid var(--border);
    border-radius:12px;
    outline:none;
    resize:vertical;
  }
  input[type="text"], input[type="number"]{
    width:100%;
    font-size:14px;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    outline:none;
    background:#f9fafb;
  }
  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width:820px){
    .grid2{ grid-template-columns:1fr; }
  }
  button{
    font-size:16px;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
  }
  button.primary{
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
  }
  button.danger{
    background:var(--danger);
    border-color:var(--danger);
    color:#fff;
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  .split{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:14px;
  }
  @media (max-width:820px){
    .split{ grid-template-columns:1fr }
  }
  .hint{
    font-size:13px;
    color:var(--muted);
    margin-top:6px;
    line-height:1.5;
  }
  .hidden{ display:none; }

  /* å­¦ç”ŸåŒº */
  #timer{
    font-size:18px;
    font-weight:700;
    color:var(--danger);
    margin:0 0 6px;
    text-align:center;
  }
  #currentCharLine{
    font-size:26px;
    font-weight:800;
    text-align:center;
    margin:0 0 10px;
  }

  /* ç”°å­—æ ¼ */
  #charStage{
    width:260px;
    height:260px;
    margin:10px auto 8px;
    position:relative;
    border-radius:12px;
    background:#fff;
    border:2px solid rgba(17,24,39,.45);
    overflow:hidden;
  }
  #charStage::before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background:
      linear-gradient(to right,
        transparent calc(50% - 1px),
        rgba(17,24,39,.35) calc(50% - 1px),
        rgba(17,24,39,.35) calc(50% + 1px),
        transparent calc(50% + 1px)
      ),
      linear-gradient(to bottom,
        transparent calc(50% - 1px),
        rgba(17,24,39,.35) calc(50% - 1px),
        rgba(17,24,39,.35) calc(50% + 1px),
        transparent calc(50% + 1px)
      );
  }
  #charBox{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .resultBox{
    text-align:center;
    padding:18px;
    border:1px dashed var(--border);
    border-radius:14px;
    background:#fafafa;
  }
</style>
</head>

<body>
<div class="wrap">

  <!-- æ•™å¸ˆ -->
  <div id="teacherPanel">
    <div class="title">æ±‰å­—ç¬”é¡ºç»ƒä¹ ï¼ˆæ•™å¸ˆæ§åˆ¶å°ï¼‰</div>

    <div class="card">
      <div class="label">è¾“å…¥æ±‰å­—ï¼ˆç”¨<strong>é¡¿å·æˆ–é€—å·</strong>åˆ†å¼€ï¼Œä¾‹å¦‚ï¼šä¸€ã€äºŒï¼Œäº”,å£ï¼Œäººï¼‰</div>
      <textarea id="charInput">ä¸€ã€äºŒï¼Œäº”,å£ï¼Œäºº</textarea>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <div class="label" style="margin:0 0 8px;">è¯·è¾“å…¥æ¸¸æˆæ—¶é—´</div>
          <input id="timeInput" type="number" min="1" max="60" value="1">
          <div class="hint">èŒƒå›´é¢„è®¾ 1â€“60 åˆ†é’Ÿ</div>
        </div>

      </div>

      <div class="row left" style="margin-top:12px;">
        <button class="primary" onclick="generateURL()">äº§ç”Ÿ URL</button>
        <button onclick="generateQR()">äº§ç”Ÿ QR Code</button>
      </div>
    </div>

    <div class="card" id="shareCard">
      <div class="label">å­¦ç”Ÿæ¸¸æˆ URL</div>
      <input id="urlBox" type="text" readonly placeholder="æŒ‰ã€Œäº§ç”Ÿ URLã€åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ">

      <div class="split" style="margin-top:12px;">
        <div>
          <div class="label">äºŒç»´ç </div>
          <div class="hint">æŒ‰ã€Œäº§ç”Ÿ QR Codeã€åä¼šæ˜¾ç¤ºåœ¨å³ä¾§åŒºåŸŸã€‚</div>
        </div>
        <div style="text-align:center">
          <div id="qrcode"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- å­¦ç”Ÿ -->
  <div id="studentPanel" class="hidden">
    <div class="title">æ±‰å­—ç¬”é¡ºæŒ‘æˆ˜</div>

    <div class="card">
      <div class="label">é€‰æ‹©é¡¹ç›®</div>
      <div class="row center">
        <button class="primary modeBtn" onclick="startMode('learn')">å­¦ä¹ </button>
        <button class="primary modeBtn" onclick="startMode('easy')">åˆçº§</button>
        <button class="primary modeBtn" onclick="startMode('medium')">ä¸­çº§</button>
        <button class="primary modeBtn" onclick="startMode('hard')">é«˜çº§</button>
      </div>
      <div class="hint">
	å­¦ä¹ ï¼šå±•ç¤ºæ‰€æœ‰å­—çš„ç¬”é¡ºï¼ˆæ²¡æœ‰æ—¶é—´é™åˆ¶ï¼‰<br> 
	åˆçº§ï¼šå†™é”™ <strong>2</strong> æ¬¡åï¼Œä¼šå‡ºç°æç¤º<br> 
	ä¸­çº§ï¼šå†™é”™ <strong>4</strong> æ¬¡åï¼Œä¼šå‡ºç°æç¤º<br> 
	é«˜çº§ï¼šæ²¡æœ‰æç¤ºã€‚åŠ æ²¹ï¼Œä½ å¯ä»¥çš„ï¼
      </div>
    </div>

    <div class="card hidden" id="gameArea">
      <div id="timer">å‰©ä½™æ—¶é—´ï¼š0:00</div>
      <div id="currentCharLine">å½“å‰å­—ï¼š-</div>

      <div id="charStage">
        <div id="charBox"></div>
      </div>

      <div class="row center">
        <button id="playBtn" onclick="play()">æ’­æ”¾ç¬”é¡º</button>
        <button id="nextBtn" class="primary" onclick="nextChar()">ä¸‹ä¸€ä¸ª</button>
        <button class="danger" onclick="resetToHome()">é‡ç½®</button>
      </div>

      <div class="hint" style="text-align:center" id="progressText"></div>
      <div class="hint" style="text-align:center" id="strokeInfo"></div>
    </div>

    <div class="card hidden" id="resultCard">
      <div class="resultBox" id="result"></div>
      <div class="row center" style="margin-top:10px;">
        <button class="primary" onclick="restart()">å›åˆ°é€‰æ‹©</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= é€šç”¨ï¼šè§£æ ================= */
function parseChars(text) {
  return text.split(/[ã€ï¼Œ,]/).map(c => c.trim()).filter(Boolean);
}
function getBaseURLWithoutQuery() {
  return window.location.href.split("?")[0];
}
function clampInt(n, min, max, fallback){
  n = parseInt(n, 10);
  if (!Number.isFinite(n)) return fallback;
  return Math.max(min, Math.min(max, n));
}

/* ================= æ•™å¸ˆï¼šç”ŸæˆURL/QRï¼ˆä¸€å®šå¯ç”¨ï¼‰ ================= */
function getTeacherMinutes() {
  // é¢„è®¾ 1â€“60 åˆ†é’Ÿï¼ˆè¦æ”¹å°±æ”¹è¿™ä¸¤ä¸ªæ•°å­—ï¼‰
  return clampInt(document.getElementById("timeInput").value, 1, 60, 1);
}
function getStudentURL() {
  const raw = document.getElementById("charInput").value;
  const chars = parseChars(raw);
  if (chars.length === 0) {
    alert("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ±‰å­—");
    return null;
  }
  const minutes = getTeacherMinutes();
  return (
    getBaseURLWithoutQuery() +
    "?chars=" + encodeURIComponent(chars.join(",")) +
    "&t=" + encodeURIComponent(String(minutes))
  );
}
function generateURL() {
  const url = getStudentURL();
  if (!url) return;
  document.getElementById("urlBox").value = url;
  document.getElementById("shareCard").scrollIntoView({ behavior: "smooth", block: "start" });
}
function generateQR() {
  const url = getStudentURL();
  if (!url) return;

  document.getElementById("urlBox").value = url;
  const qr = document.getElementById("qrcode");
  qr.innerHTML = "";
  new QRCode(qr, { text: url, width: 180, height: 180 });

  document.getElementById("shareCard").scrollIntoView({ behavior: "smooth", block: "start" });
}

/* ================= å­¦ç”Ÿï¼šåªæœ‰åœ¨å­¦ç”Ÿæ¨¡å¼æ‰è¯»å– query ================= */
const params = new URLSearchParams(window.location.search);
const rawChars = params.get("chars");

/* å­¦ç”Ÿç«¯ï¼šè¯»å–è€å¸ˆè®¾å®šçš„åˆ†é’Ÿæ•°ï¼ˆtï¼‰ï¼Œé»˜è®¤ 1 åˆ†é’Ÿ */
function readGameSecondsFromQuery() {
  // é¢„è®¾ 1â€“60 åˆ†é’Ÿï¼ˆè¦æ”¹å°±æ”¹è¿™ä¸¤ä¸ªæ•°å­—ï¼‰
  const minutes = clampInt(params.get("t"), 1, 60, 1);
  return minutes * 60;
}

/* ================= å­¦ç”Ÿï¼šéš¾åº¦å‚æ•° ================= */
const difficulty = {
  easy:   { maxDistance: 18, hintAfter: 2 },
  medium: { maxDistance: 12, hintAfter: 4 },
  hard:   { maxDistance: 8,  hintAfter: 999999 },
  learn:  { maxDistance: 18, hintAfter: 999999 }
};

/* ================= å­¦ç”Ÿï¼šçŠ¶æ€ ================= */
let chars = [];
let idx = 0;
let writer = null;

let completedChars = 0;
let GAME_SECONDS = 60;   // å­¦ç”Ÿæ¨¡å¼ä¼šè¦†ç›–
let timeLeft = 60;
let timerId = null;

let currentMode = null;
let modeConfig = null;

let mistakesThisChar = 0;
let strokeMistakes = {};   // âœ… æ¯ä¸€ç¬”å„è‡ªè®¡é”™ï¼ˆä¿®å¤ï¼šä¸ä¼šâ€œä¸‹ä¸€ç¬”ä¸€é”™å°±æç¤ºâ€ï¼‰
let lastHintStroke = null;
let lastHintAt = 0;

/* ================= è¿›å…¥å­¦ç”Ÿæ¨¡å¼/æ•™å¸ˆæ¨¡å¼ ================= */
if (rawChars) {
  document.getElementById("teacherPanel").classList.add("hidden");
  document.getElementById("studentPanel").classList.remove("hidden");

  chars = rawChars.split(",").map(s => s.trim()).filter(Boolean);
  GAME_SECONDS = readGameSecondsFromQuery();
  timeLeft = GAME_SECONDS;
  updateTimerText();
}

/* ================= UI helpers ================= */
function lockModeButtons(locked) {
  document.querySelectorAll(".modeBtn").forEach(b => b.disabled = locked);
}
function updateCurrentCharUI() {
  const ch = (chars && chars.length) ? chars[idx] : "-";
  document.getElementById("currentCharLine").innerText = `å½“å‰å­—ï¼š${ch}`;
}
function updateProgressText() {
  const modeName =
    currentMode === "learn" ? "å­¦ä¹ " :
    currentMode === "easy" ? "åˆçº§" :
    currentMode === "medium" ? "ä¸­çº§" : "é«˜çº§";

  const extra = (currentMode === "learn") ? "" : `å·²æˆåŠŸå†™å¯¹ï¼š${completedChars} ä¸ª`;
  document.getElementById("progressText").innerText =
    extra ? `é¡¹ç›®ï¼š${modeName}ï½œ${extra}` : `é¡¹ç›®ï¼š${modeName}`;
}

/* ================= æç¤ºï¼ˆæµ…è“ï¼‰ ================= */
const HINT_COLOR = "#93c5fd";
const HINT_MS = 450;
const HINT_COOLDOWN_MS = 250;

function getCorrectStrokeIndex(strokeData) {
  const raw = (strokeData && typeof strokeData.strokeNum === "number") ? strokeData.strokeNum : 0;

  const canInferTotal =
    strokeData &&
    typeof strokeData.strokeNum === "number" &&
    typeof strokeData.strokesRemaining === "number";

  if (canInferTotal) {
    const total = strokeData.strokeNum + strokeData.strokesRemaining;
    if (typeof total === "number" && total > 0) {
      let n = raw;
      if (n < 0 || n >= total) n = raw - 1;
      if (n < 0 || n >= total) n = 0;
      return n;
    }
  }
  return Math.max(0, raw);
}

function hintCurrentStroke(strokeData) {
  if (!writer) return;
  if (typeof writer.highlightStroke !== "function") return;

  const n = getCorrectStrokeIndex(strokeData);
  const now = Date.now();
  if (lastHintStroke === n && (now - lastHintAt) < HINT_COOLDOWN_MS) return;

  lastHintStroke = n;
  lastHintAt = now;

  try {
    writer.highlightStroke(n, { strokeColor: HINT_COLOR, outlineColor: HINT_COLOR });
    setTimeout(() => {
      if (typeof writer.unhighlightStroke === "function") writer.unhighlightStroke(n);
      if (typeof writer.cancelHighlight === "function") writer.cancelHighlight();
    }, HINT_MS);
  } catch (e) {}
}

/* ================= é‡ç½® ================= */
function goToStudentHome() {
  if (timerId) clearInterval(timerId);
  timerId = null;

  if (writer) {
    try { writer.cancelQuiz(); } catch(e) {}
  }

  currentMode = null;
  modeConfig = null;
  completedChars = 0;
  idx = 0;

  mistakesThisChar = 0;
  strokeMistakes = {};   // âœ… æ¸…ç©ºæ¯ç¬”è®¡é”™
  lastHintStroke = null;
  lastHintAt = 0;

  timeLeft = GAME_SECONDS;
  updateTimerText();

  document.getElementById("gameArea").classList.add("hidden");
  document.getElementById("resultCard").classList.add("hidden");
  lockModeButtons(false);

  document.getElementById("studentPanel").scrollIntoView({ behavior: "smooth", block: "start" });
}

function resetToHome() {
  if (currentMode === "learn") {
    goToStudentHome();
    return;
  }
  const ok = window.confirm("ä½ çš„æ¸¸æˆåˆ†æ•°å°†å½’é›¶å“¦ï¼");
  if (ok) goToStudentHome();
}

/* ================= æ¨¡å¼ UIï¼šå­¦ä¹ æ˜¾ç¤ºæ’­æ”¾+ä¸‹ä¸€ä¸ªï¼Œéšè—timerï¼›å…¶ä»–ç›¸å ================= */
function applyModeUI() {
  const timerEl = document.getElementById("timer");
  const playBtn = document.getElementById("playBtn");
  const nextBtn = document.getElementById("nextBtn");

  if (currentMode === "learn") {
    timerEl.classList.add("hidden");
    playBtn.classList.remove("hidden");
    nextBtn.classList.remove("hidden");
  } else {
    timerEl.classList.remove("hidden");
    playBtn.classList.add("hidden");
    nextBtn.classList.add("hidden"); // åˆ/ä¸­/é«˜ï¼šæ²¡æœ‰ä¸‹ä¸€ä¸ªï¼ˆå­¦ç”Ÿå¿…é¡»å†™ï¼‰
  }
}

/* ================= å¼€å§‹æ¨¡å¼ ================= */
function startMode(mode) {
  if (!chars || chars.length === 0) {
    alert("é“¾æ¥é‡Œæ²¡æœ‰æ±‰å­—ï¼ˆchars å‚æ•°ä¸ºç©ºï¼‰");
    return;
  }

  currentMode = mode;
  modeConfig = difficulty[mode];

  idx = 0;
  completedChars = 0;

  if (currentMode === "learn") {
    if (timerId) clearInterval(timerId);
    timerId = null;
    timeLeft = GAME_SECONDS; // ä¸å€’æ•°
  } else {
    timeLeft = GAME_SECONDS; // ç”¨è€å¸ˆè®¾å®šçš„æ—¶é—´å€’æ•°
  }

  updateTimerText();
  applyModeUI();

  lockModeButtons(true);
  document.getElementById("resultCard").classList.add("hidden");
  document.getElementById("gameArea").classList.remove("hidden");
  document.getElementById("strokeInfo").innerText = "";

  loadCurrentChar();

  if (currentMode !== "learn") startTimer();
}

/* ================= Hanzi Writer ================= */
function createWriterForChar(ch) {
  document.getElementById("charBox").innerHTML = "";
  return HanziWriter.create("charBox", ch, {
    width: 260,
    height: 260,
    padding: 18,
    showCharacter: false,
    showOutline: false
  });
}

function loadCurrentChar() {
  if (writer) {
    try { writer.cancelQuiz(); } catch(e) {}
  }

  mistakesThisChar = 0;
  strokeMistakes = {};   // âœ… æ¯æ¢ä¸€ä¸ªå­—å°±é‡ç½®â€œæ¯ä¸€ç¬”çš„é”™è¯¯æ¬¡æ•°â€
  lastHintStroke = null;
  lastHintAt = 0;

  writer = createWriterForChar(chars[idx]);

  updateCurrentCharUI();
  updateProgressText();
  document.getElementById("strokeInfo").innerText = "";

  if (currentMode === "learn") {
    writer.showOutline();
    writer.animateCharacter();
    return;
  }

  writer.quiz({
    showHintAfterMisses: false,

    onStrokeEnd: (i, c, ok) => {
      document.getElementById("strokeInfo").innerText =
        ok ? `âœ” ç¬¬ ${i+1} ç¬”æ­£ç¡®` : "âŒ ç¬”é¡ºæˆ–ä½ç½®ä¸å¯¹";
    },

    customStrokeValidator: (student, correct) => {
      if (!student) return true;
      const maxD = modeConfig.maxDistance;
      for (let i = 0; i < student.length; i++) {
        const d = Math.hypot(student[i][0] - correct[i][0], student[i][1] - correct[i][1]);
        if (d > maxD) return false;
      }
      return true;
    },

    onMistake: (strokeData) => {
      mistakesThisChar++;

      // âœ… ä¿®å¤ï¼šæŒ‰â€œæ¯ä¸€ç¬”â€å„è‡ªè®¡é”™ï¼Œè¾¾åˆ°é˜ˆå€¼æ‰æç¤ºè¯¥ç¬”
      const strokeIdx = getCorrectStrokeIndex(strokeData);
      strokeMistakes[strokeIdx] = (strokeMistakes[strokeIdx] || 0) + 1;

      if (strokeMistakes[strokeIdx] >= modeConfig.hintAfter) {
        hintCurrentStroke(strokeData);
      }
    },

    onComplete: () => {
      completedChars++;
      updateProgressText();

      try { writer.showCharacter(); } catch(e) {}
      try { writer.hideOutline(); } catch(e) {}

      setTimeout(() => {
        if (timeLeft <= 0) return;
        idx = (idx + 1) % chars.length;
        loadCurrentChar();
      }, 1000);
    }
  });
}

/* å­¦ä¹ æ¨¡å¼æŒ‰é’® */
function play() { if (writer) writer.animateCharacter(); }
function nextChar() {
  idx = (idx + 1) % chars.length;
  loadCurrentChar();
}

/* ================= å€’æ•°ï¼ˆä»…åˆ/ä¸­/é«˜ï¼‰ ================= */
function startTimer() {
  updateTimerText();
  if (timerId) clearInterval(timerId);

  timerId = setInterval(() => {
    timeLeft--;
    updateTimerText();
    if (timeLeft <= 0) endGame();
  }, 1000);
}

function updateTimerText() {
  const m = Math.floor(timeLeft / 60);
  const s = String(timeLeft % 60).padStart(2, "0");
  document.getElementById("timer").innerText = `å‰©ä½™æ—¶é—´ï¼š${m}:${s}`;
}

function endGame() {
  if (timerId) clearInterval(timerId);
  timerId = null;

  if (writer) {
    try { writer.cancelQuiz(); } catch(e) {}
  }

  document.getElementById("gameArea").classList.add("hidden");
  document.getElementById("resultCard").classList.remove("hidden");

  document.getElementById("result").innerHTML =
    `ğŸ‰ <h3 style="margin:8px 0;">æ­å–œä½ ï¼</h3>
     <p style="margin:0; font-size:16px;">ä½ å·²ç»æˆåŠŸå†™äº† <strong style="font-size:20px;">${completedChars}</strong> ä¸ªå­—ï¼</p>`;
}

function restart() {
  if (timerId) clearInterval(timerId);
  timerId = null;

  if (writer) {
    try { writer.cancelQuiz(); } catch(e) {}
  }

  lockModeButtons(false);
  document.getElementById("resultCard").classList.add("hidden");
  document.getElementById("gameArea").classList.add("hidden");
  document.getElementById("strokeInfo").innerText = "";
}
</script>

</body>
</html>

